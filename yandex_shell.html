<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>PvZ Portable</title>
<style>
html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden; background:#000;
  touch-action:none; -webkit-touch-callout:none; -webkit-user-select:none; user-select:none; }
#canvas { display:block; position:absolute; }
</style>
<script src="https://yandex.ru/games/sdk/v2"></script>
</head>
<body>
<canvas id="canvas" oncontextmenu="event.preventDefault()" tabindex="-1"></canvas>

<script>
/** fitCanvas() â€” see yandex_shell_stub.html for full doc */
function fitCanvas() {
  var vw = window.innerWidth, vh = window.innerHeight;
  var cw, ch;
  if (vw / vh > 4 / 3) { ch = vh; cw = Math.round(vh * 4 / 3); }
  else { cw = vw; ch = Math.round(vw * 3 / 4); }
  var c = document.getElementById('canvas');
  if (!c) return;
  c.style.setProperty('width',  cw + 'px', 'important');
  c.style.setProperty('height', ch + 'px', 'important');
  c.style.setProperty('left', Math.round((vw - cw) / 2) + 'px', 'important');
  c.style.setProperty('top',  Math.round((vh - ch) / 2) + 'px', 'important');
}
fitCanvas();
window.addEventListener('resize', fitCanvas);

var ysdk = null;
var ygPlayer = null;

var ygPlayerReady = null;
var ygPlayerPromise = new Promise(function(resolve) { ygPlayerReady = resolve; });

window.YG = {
  sdk: null,
  player: null,
  ready: false,

  init: function() {
    return YaGames.init().then(function(sdk) {
      ysdk = sdk;
      window.YG.sdk = sdk;
      return sdk.getPlayer({ scopes: false }).then(function(p) {
        ygPlayer = p;
        window.YG.player = p;
      }).catch(function() {}).then(function() { ygPlayerReady(); });
    }).catch(function() { ygPlayerReady(); });
  },

  signalReady: function() {
    if (ysdk && ysdk.features && ysdk.features.LoadingAPI) {
      ysdk.features.LoadingAPI.ready();
    }
    window.YG.ready = true;
  },

  showInterstitial: function() {
    if (!ysdk) return;
    ysdk.adv.showFullscreenAdv({ callbacks: {
      onOpen: function() { if (Module._pvz_yg_on_ad_open) Module._pvz_yg_on_ad_open(); },
      onClose: function() { if (Module._pvz_yg_on_ad_close) Module._pvz_yg_on_ad_close(); },
      onError: function() { if (Module._pvz_yg_on_ad_close) Module._pvz_yg_on_ad_close(); }
    }});
  },

  showRewarded: function(onReward) {
    if (!ysdk) return;
    ysdk.adv.showRewardedVideo({ callbacks: {
      onOpen: function() { if (Module._pvz_yg_on_ad_open) Module._pvz_yg_on_ad_open(); },
      onRewarded: function() { if (onReward) onReward(); },
      onClose: function() { if (Module._pvz_yg_on_ad_close) Module._pvz_yg_on_ad_close(); },
      onError: function() { if (Module._pvz_yg_on_ad_close) Module._pvz_yg_on_ad_close(); }
    }});
  },

  saveData: function(key, base64data) {
    return ygPlayerPromise.then(function() {
      if (!ygPlayer) {
        try { localStorage.setItem('yg_save_' + key, base64data); } catch(e){}
        return true;
      }
      var obj = {};
      obj[key] = base64data;
      return ygPlayer.setData(obj, true).then(function() { return true; })
        .catch(function() { return false; });
    });
  },

  loadData: function(key) {
    return ygPlayerPromise.then(function() {
      if (!ygPlayer) {
        return localStorage.getItem('yg_save_' + key);
      }
      return ygPlayer.getData([key]).then(function(data) {
        return data[key] || null;
      }).catch(function() { return null; });
    });
  },

  deleteData: function(key) {
    return ygPlayerPromise.then(function() {
      if (!ygPlayer) {
        localStorage.removeItem('yg_save_' + key);
        return true;
      }
      var obj = {};
      obj[key] = undefined;
      return ygPlayer.setData(obj, true).then(function() { return true; })
        .catch(function() { return false; });
    });
  }
};

document.addEventListener('visibilitychange', function() {
  if (document.hidden) {
    if (typeof Module !== 'undefined' && Module._pvz_yg_on_visibility_hidden)
      Module._pvz_yg_on_visibility_hidden();
  } else {
    if (typeof Module !== 'undefined' && Module._pvz_yg_on_visibility_visible)
      Module._pvz_yg_on_visibility_visible();
  }
});

document.addEventListener('contextmenu', function(e) { e.preventDefault(); });

var Module = {
  canvas: (function() { return document.getElementById('canvas'); })()
};
window.onerror = function(e) { console.error('PvZ error:', e); };

window.YG.init().then(function() {});
</script>
{{{ SCRIPT }}}
</body>
</html>
