<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>PvZ Portable</title>
<style>
html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden; background:#000;
  touch-action:none; -webkit-touch-callout:none; -webkit-user-select:none; user-select:none; }
#canvas { display:block; position:absolute; }
#loading { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
  color:#fff; font:20px sans-serif; text-align:center; z-index:10; }
#loading .bar { width:300px; height:20px; border:2px solid #555; margin:10px auto; border-radius:4px; }
#loading .fill { height:100%; background:#4a0; width:0%; transition:width .2s; border-radius:4px; }
</style>
<script src="https://yandex.ru/games/sdk/v2"></script>
</head>
<body>
<div id="loading">
  <div>Loading PvZ Portable...</div>
  <div class="bar"><div class="fill" id="progress"></div></div>
  <div id="status">Initializing SDK...</div>
</div>
<canvas id="canvas" oncontextmenu="event.preventDefault()" tabindex="-1"></canvas>

<script>
/** fitCanvas() â€” see yandex_shell_stub.html for full doc */
function fitCanvas() {
  var vw = window.innerWidth, vh = window.innerHeight;
  var cw, ch;
  if (vw / vh > 4 / 3) { ch = vh; cw = Math.round(vh * 4 / 3); }
  else { cw = vw; ch = Math.round(vw * 3 / 4); }
  var c = document.getElementById('canvas');
  if (!c) return;
  c.style.setProperty('width',  cw + 'px', 'important');
  c.style.setProperty('height', ch + 'px', 'important');
  c.style.setProperty('left', Math.round((vw - cw) / 2) + 'px', 'important');
  c.style.setProperty('top',  Math.round((vh - ch) / 2) + 'px', 'important');
}
fitCanvas();
window.addEventListener('resize', fitCanvas);

var ysdk = null;
var ygPlayer = null;

window.YG = {
  sdk: null,
  player: null,
  ready: false,

  init: function() {
    return YaGames.init().then(function(sdk) {
      ysdk = sdk;
      window.YG.sdk = sdk;
      document.getElementById('status').textContent = 'SDK ready, loading game...';
      return sdk.getPlayer({ scopes: false }).then(function(p) {
        ygPlayer = p;
        window.YG.player = p;
      }).catch(function() {});
    });
  },

  signalReady: function() {
    if (ysdk && ysdk.features && ysdk.features.LoadingAPI) {
      ysdk.features.LoadingAPI.ready();
    }
    window.YG.ready = true;
    var el = document.getElementById('loading');
    if (el) el.style.display = 'none';
  },

  showInterstitial: function() {
    if (!ysdk) return;
    ysdk.adv.showFullscreenAdv({ callbacks: {
      onOpen: function() { if (Module._pvz_yg_on_ad_open) Module._pvz_yg_on_ad_open(); },
      onClose: function() { if (Module._pvz_yg_on_ad_close) Module._pvz_yg_on_ad_close(); },
      onError: function() { if (Module._pvz_yg_on_ad_close) Module._pvz_yg_on_ad_close(); }
    }});
  },

  showRewarded: function(onReward) {
    if (!ysdk) return;
    ysdk.adv.showRewardedVideo({ callbacks: {
      onOpen: function() { if (Module._pvz_yg_on_ad_open) Module._pvz_yg_on_ad_open(); },
      onRewarded: function() { if (onReward) onReward(); },
      onClose: function() { if (Module._pvz_yg_on_ad_close) Module._pvz_yg_on_ad_close(); },
      onError: function() { if (Module._pvz_yg_on_ad_close) Module._pvz_yg_on_ad_close(); }
    }});
  },

  saveData: function(key, base64data) {
    if (!ygPlayer) {
      try { localStorage.setItem('yg_save_' + key, base64data); } catch(e){}
      return Promise.resolve(true);
    }
    var obj = {};
    obj[key] = base64data;
    return ygPlayer.setData(obj, true).then(function() { return true; })
      .catch(function() { return false; });
  },

  loadData: function(key) {
    if (!ygPlayer) {
      return Promise.resolve(localStorage.getItem('yg_save_' + key));
    }
    return ygPlayer.getData([key]).then(function(data) {
      return data[key] || null;
    }).catch(function() { return null; });
  },

  deleteData: function(key) {
    if (!ygPlayer) {
      localStorage.removeItem('yg_save_' + key);
      return Promise.resolve(true);
    }
    var obj = {};
    obj[key] = undefined;
    return ygPlayer.setData(obj, true).then(function() { return true; })
      .catch(function() { return false; });
  }
};

document.addEventListener('visibilitychange', function() {
  if (document.hidden) {
    if (typeof Module !== 'undefined' && Module._pvz_yg_on_visibility_hidden)
      Module._pvz_yg_on_visibility_hidden();
  } else {
    if (typeof Module !== 'undefined' && Module._pvz_yg_on_visibility_visible)
      Module._pvz_yg_on_visibility_visible();
  }
});

document.addEventListener('contextmenu', function(e) { e.preventDefault(); });

var Module = {
  canvas: (function() { return document.getElementById('canvas'); })(),
  setStatus: function(text) {
    var el = document.getElementById('status');
    if (el) el.textContent = text;
    var m = text.match(/(\d+)\/(\d+)/);
    if (m) {
      var pct = Math.round(100 * parseInt(m[1]) / parseInt(m[2]));
      var fill = document.getElementById('progress');
      if (fill) fill.style.width = pct + '%';
    }
  },
  onRuntimeInitialized: function() {
    document.getElementById('status').textContent = 'Loading assets...';
  }
};
window.onerror = function(e) { Module.setStatus('Error: ' + e); };

window.YG.init().then(function() {});
</script>
{{{ SCRIPT }}}
</body>
</html>
